# Deploying YDB cluster with Ansible

Ansible playbooks supporting the deployment of [YDB](https://ydb.tech) clusters into VM or baremetal servers.

Currently the playbooks provided support the following scenarious:
* the initial deployment of YDB static (storage) nodes;
* the initial deployment of YDB dynamic (database) nodes;
* adding extra YDB dynamic nodes to the YDB cluster.

The following scenarious are yet to be implemented:
* configuring extra storage devices within the existing YDB static nodes;
* adding extra YDB static nodes to the existing cluster;
* removing YDB dynamic nodes from the existing cluster.

One important limitation of the current playbooks is that the cluster configuration file has to be manually created.

Playbooks were tested on the following Linux flavours:
* Ubuntu 22.04 LTS
* AlmaLinux 9
* AstraLinux Special Edition 1.7

Yet to be checked:
* AlmaLinux 8
* REDOS 7.3

## Installing the YDB cluster using the Ansible playbooks

Overall installation is performed according to the [official instruction](https://ydb.tech/en/docs/deploy/manual/deploy-ydb-on-premises), with several steps automated with Ansible. The steps below are adopted for the Ansible-based process:
1. [Review the system requirements](https://ydb.tech/en/docs/deploy/manual/deploy-ydb-on-premises#requirements), and prepare the YDB hosts. Ensure that SSH access and sudo-based root privileges are available.
2. [Prepare the TLS certificates](https://ydb.tech/en/docs/deploy/manual/deploy-ydb-on-premises#tls-certificates), the provided [sample script](https://github.com/ydb-platform/ydb/tree/main/ydb/deploy/tls_cert_gen) may be used for automation of this step.
3. Download the [YDB server distribution](https://ydb.tech/en/docs/downloads/#ydb-server). It is better to use the latest binary version available.
4. Clone the [Github repository](https://github.com/zinal/ydb-snippets/tree/main/ydb-ansible) containing the YDB Ansible playbooks:
    ```bash
    git clone https://github.com/zinal/ydb-snippets.git
    cd ydb-ansible
    ```
5. Prepare the list of hosts to deploy the YDB static nodes, as a `hosts-static` file. An example file is provided.
6. Prepare the cluster configuration file [according to the instructions in the documentation](https://ydb.tech/en/docs/deploy/manual/deploy-ydb-on-premises#config), and save it to the `files` subdirectory.
7. Copy the `group_vars/all.example` file into `group_vars/all`, and customize it according to your environment:
   * `ansible_python_interpreter` must be specified as the correct path to Python interpreter on the future YDB hosts;
   * `libidn_archive` is used to enable the installation of custom-built libidn for RHEL, AlmaLinux or Rocky Linux 9;
   * `ydbd_dir` is the path of the YDB software installation directory to be created on the hosts;
   * `ydbd_tls_dir` is the path to the directory with the TLS certificates and keys, as generated by the [sample script](https://github.com/ydb-platform/ydb/tree/main/ydb/deploy/tls_cert_gen), or following the filename convention used by the sample script;
   * `ydbd_archive` must point to the YDB server binary package downloaded;
   * `ydbd_config` shoud be the name of the cluster configuration file within the `files` subdirectory.
8. Copy the `group_vars/ydbd_static.example` file into `group_vars/ydbd_static`, and specify the desired disk layout. `ydbd_disks` parameter is the list of structures, each having the following fields:
   *  `name` pointing to the physical device name (like `/dev/sdb` or `/dev/vdb`);
   *  `label` configured as the desired YDB data partition label, as used in the cluster configuration file (like `ydb_disk_1`).
9.  Deploy the static nodes and initialize the cluster by running the `run-install-static.sh` script. Ensure that the playbook has completed successfully, diagnose and fix execution errors if they happen.
10. Create at least one database [according to the documentation](https://ydb.tech/en/docs/deploy/manual/deploy-ydb-on-premises#create-db). Multiple databases may run on the single cluster, each requiring the YDB dynamic node services to handle the requests. Sample commands to create the database:
    ```bash
    PATH=/opt/ydb/bin:$PATH
    export PATH

    CACERT=/opt/ydb/cfg/ca.crt
    DBNAME=testdb
    POOLNAME=ssd
    NUMGROUPS=3

    # Create the authentication token file
    ydb -e grpcs://`hostname -f`:2135 -d /Root --ca-file ${CACERT} \
      --user root --no-password auth get-token --force >ydbd-token-file

    # Create the database
    ydbd -f ydbd-token-file --ca-file ${CACERT} -s grpcs://`hostname -f`:2135 \
        admin database /Root/${DBNAME} create ${POOLNAME}:${NUMGROUPS}
    ```
11. Prepare the list of hosts to deploy the YDB dynamic nodes, as a `hosts-dynamic` file. An example file is provided.
12. Copy the `group_vars/ydbd_dynamic.example` file into `group_vars/ydbd_dynamic`, and specify the desired list of dynamic nodes to be ran on each host:
    * `ydbd_dynnodes` parameter is the list of structures, each having the following fields:
      * `dbname` - name of the YDB database handled by the corresponding dynamic node;
      * `instance` - dynamic node service instance name, allowing to distinguish between multiple dynamic nodes for the same database running in the same host;
      * `offset` - integer number, used as the offset for the standard network port numbers (`0` means using the standard ports).
    *  `ydbd_brokers` is the list of host names running the YDB static nodes, exactly 3 (three) host names must be specified.
13. Deploy the static nodes and initialize the cluster by running the `run-install-dynamic.sh` script. Ensure that the playbook has completed successfully, diagnose and fix execution errors if they happen.
14. Repeat steps 10-13 as necessary to create more databases, or steps 11-12 to deploy more YDB dynamic nodes.

## What is actually done by the playbooks?

### Actions executed for all YDB nodes
1. libaio or libaio1 is installed, depending on the operating system
2. chrony is installed and enabled to ensure time synchronization
3. YDB user group and user is created
4. YDB installation directory is created
5. YDB server software binary package is unpacked into the YDB installation directory
6. YDB TLS certificates and keys are copied to each node
7. YDB client package automatic update checks are disabled for the YDB user, to avoid extra messages from client commands.
8. YDB cluster configuration file is copied to each node.

### Actions executed for the initial deployment of YDB storage cluster
1. All-node actions are executed.
2. For each disk configured, it is checked for the existing YDB data. If none found, disk is completely re-partitioned, and obliterated. For the existing YDB data, no changes are made.
   > WARNING: the safety checks do not work for YDB disks using non-default encryption keys. DATA LOSS IS POSSIBLE if the encryption is actually used. Probably an enhancement is needed to support the encryption key to be specified in the deployment option.
3. `ydbd-storage.service` is created and configured as the systemd service.
4. `ydbd-storage.service` is started, and the playbook waits for static nodes to come up.
5. YDB blobstorage configuration is applied with the `ydbd admin blobstorage init` command.

### Actions executed for YDB dynamic nodes deployment
1. All-node actions are executed.
2. For each database configured, the list of YDB dynnode systemd services are created and configured.
3. YDB dynnode services are started.
