#! /bin/sh
# Initialize or reconfigure YDB storage.

set +e
set +u

DB_ENDPOINT=grpcs://"$1":2135
DB_DOMAIN=/Root
CAFILE={{ ydbd_dir }}/certs/ca.crt
CONFIG={{ ydbd_dir }}/cfg/ydbd-config.yaml
TOKEN={{ ydbd_dir }}/home/ydbd-token-file
PASSFILE={{ ydbd_dir }}/certs/secret

LD_LIBRARY_PATH={{ ydbd_dir }}/lib
export LD_LIBRARY_PATH

PATH={{ ydbd_dir }}/bin:$PATH
export PATH

set -e
set -u

if [ -f ${PASSFILE} ]; then
  # Username and password are passed in file for reconfiguration.
  . ${PASSFILE}
  ydb --ca-file ${CAFILE} -e ${DB_ENDPOINT} -d ${DB_DOMAIN} \
    auth get-token -f > ${TOKEN}
else
  # Initial cluster setup with empty password
  ydb --ca-file ${CAFILE} -e ${DB_ENDPOINT} -d ${DB_DOMAIN} \
    --user root --no-password auth get-token -f > ${TOKEN}
fi
trap "rm -f ${TOKEN}" EXIT

ydbd --ca-file ${CAFILE} -s ${DB_ENDPOINT} -f ${TOKEN} \
  admin blobstorage config init --yaml-file ${CONFIG}

# End Of File