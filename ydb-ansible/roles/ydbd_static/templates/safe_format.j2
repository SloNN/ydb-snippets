#! /bin/sh

set -e
set +u

disk_name="$1"
disk_label="$2"
disk_part=/dev/disk/by-partlabel/"$2"

if [ -z "$disk_name" ] || [ -z "disk_label" ]; then
    echo "USAGE: $0 /dev/vdb /dev/disk/by-partlabel/ydb_disk_1" >&2
    exit 2
fi

if [ ! -b "$disk_name" ]; then
    echo "ERROR: disk $disk_name is not a block device" >&2
    exit 1
fi

date >&2
echo "Running $0 $*" >&2

if [ ! -e "$disk_part" ]; then
    echo "Re-generating partition table for ${disk_name} on "`hostname -f` >&2
    parted ${disk_name} mklabel gpt -s
    parted -a optimal ${disk_name} mkpart primary '0%' '100%'
    parted ${disk_name} name 1 ${disk_label}
    partprobe ${disk_name}
    sleep 1
    dd if=/dev/zero of=${disk_part} bs=1M count=1 status=none
fi

OVAL0='3a3ed164e42500a1c5b2d0093f0a813d27dc50d038f330cc100a7e70ece2e6e4'
OVAL1=`dd if=${disk_part} bs=1024 count=96 status=none | sha256sum | (read x y && echo $x)`
if [ ! "${OVAL0}" = "${OVAL1}" ]; then
    echo "Formatting YDB disk ${disk_part} on "`hostname -f` >&2
    LD_LIBRARY_PATH={{ ydbd_dir }}/lib {{ ydbd_dir }}/bin/ydbd admin bs disk obliterate ${disk_part}
else
    echo "Skipped formatting YDB disk ${disk_part} on "`hostname -f` >&2
fi

# End Of File